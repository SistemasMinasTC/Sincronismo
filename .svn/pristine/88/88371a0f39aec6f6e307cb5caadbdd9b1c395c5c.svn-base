#!/usr/bin/python
#
import os
import logging
from logging.handlers import RotatingFileHandler

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(name)s:%(funcName)s %(levelname)s: %(message)s",
    handlers=[
        RotatingFileHandler(
            filename="/var/log/sincronismo.log" if os.getenv('AMBIENTE_NSS') == 'PRODUCAO' else "/tmp/sincronismo_teste.log",
            encoding="utf-8",
            maxBytes=0x500000,
            backupCount=3
        )
    ]
)

from pywebio import start_server
from biblioteca.sincroniza import Sincroniza
from front.interface import Interface

# Instâncias do sincronizador
sincronizador = {}
for banco in ('minas','nautico'):
    sincronizador[banco] = Sincroniza (
        banco,                      # Banco
        '_cota_',                   # Cota
        '_movimentacao_receita_',   # ReceitaCota
        'associado',                # Pessoa
        'associado_excl',           # Pessoa
        'cota_associado',           # Associado
        'disp_entrada_saida',       # DipositivoAcesso
        'nacionalidade',            # Nacionalidade
        'parcela_plano',            # ParcelaPlanoCobranca
        'plano_cobranca',           # PlanoCobranca
        'portaria',                 # Portaria
        'profissoes',               # Profissao
        'receita',                  # Receita
        'taxa_parentesco',          # Vinculo e TaxaDependente
        'tipo_concessao',           # ClasseCota
        'tipo_contribuinte',        # ClasseCota
        'tipo_cota',                # ClasseCota
        'tipo_documento',           # TipoDocumento
        'tipo_receita',             # TipoReceita
        'uf',                       # UF
        'unidade',                  # Unidade
    )
    sincronizador[banco].start()

sincronizador['acesso'] = Sincroniza (
    'acesso',                       # banco
    'usuario',                      # usuario
)

sincronizador['acesso'].start()

def main():
    interface = Interface(sincronizador)

if __name__ == "__main__":
    logging.info('Início do processamento')

    start_server(
        main,
        port=1972 if os.getenv('AMBIENTE_NSS') != 'PRODUCAO' else 1957,
        debug=True,
        static_dir='front/static'
    )

    logging.info('Fim do processamento')
