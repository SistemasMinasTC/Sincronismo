#!/usr/bin/python
#

import time, threading, logging
from importlib import import_module
from recordtype import recordtype
from datetime import datetime
from biblioteca.conexoes import *
from copy import copy
from logging.handlers import RotatingFileHandler
logging.basicConfig (
    level = logging.INFO,
    format = "%(asctime)s %(name)s:%(funcName)s %(levelname)s: %(message)s",
    handlers = [
        RotatingFileHandler(
            filename = "/var/log/mc_log" if os.getenv('AMBIENTE_NSS') == 'PRODUCAO' else "/tmp/sincronismo_teste.log",
            encoding = "utf-8",
            maxBytes = 0x500000,
            backupCount = 3
        )
    ]
)

class Sincroniza(object):
    def __init__(self, nome, *tabelas):
        self.STOP = False
        self.Pause = False

        self.nome = nome
        self.banco = 'minas'
        self.tabelas = {tab: import_module(f'sincronismo.{tab}') for tab in tabelas}

        self.conn_ifx = conecta_informix(self.banco)
        self.conn_sql = conecta_mssql()

    def start(self):
        self.STOP = False
        self.Pause = False
        self.sincronismo = threading.Thread(target=self.process, args=())
        self.sincronismo.start()

    def stop(self):
        self.STOP = True
        self.sincronismo.join()
        print('sincronismo interrompido')

    def process(self):
        print(f'\n\nsincronismo {self.nome} iniciado {self.tabelas.keys()}')
        while not self.STOP:
            ifx = conecta_informix(self.banco)
            cr_ifx = ifx.cursor()
            cr_ifx_update = ifx.cursor()

            sql = conecta_mssql()
            cr_sql = sql.cursor()

            # driver do sql só suporta um cursor ativo por vez
            #
            sql_update = conecta_mssql()
            cr_sql_update = sql_update.cursor()

            cr_ifx.execute("""
                select first 500
                    id,
                    data_hora,
                    banco,
                    tabela,
                    operacao,
                    pk
                from mc_log
                where
                    id in ((select id from (select tabela,pk,min(id) as id from mc_log where atualizacao is null or tentativas < 3 group by tabela,pk) as Primeiro))
                order by tentativas,data_hora
            """)
            Linha = recordtype('Linha',[col[0] for col in cr_ifx.description])

            cr_sql.execute(
            """
                select top 500
                    id,
                    data_hora,
                    banco,
                    tabela,
                    operacao,
                    pk
                from mc_log
                where
                    id in ((select id from (select tabela,pk,min(id) as id from mc_log where atualizacao is null or tentativas < 3  group by tabela,pk) as Primeiro))
                order by tentativas,data_hora
            """
            )

            Fila = recordtype('Fila','conexao, cursor, cursor_update, linha')
            filas = {}
            filas['ifx']=Fila('ifx', cr_ifx, cr_ifx_update, None)
            filas['sql']=Fila('sql', cr_sql, cr_sql_update, None)

            # Faz as primeiras leituras
            #
            for key in filas:
                f = filas[key]
                f.linha = f.cursor.fetchone()
                f.linha = Linha(*f.linha) if f.linha else None

            # loop do merge
            #
            while True:
                if self.STOP:
                    break

                menor = Fila(None,None,None,None)

                for key in filas:
                    f = filas[key]
                    if (f.linha.data_hora if f.linha else datetime.now()) < (menor.linha.data_hora if menor.linha else datetime.now()):
                        menor = f

                if not menor.linha:
                    break

                if menor.linha.tabela in self.tabelas:
                    print(menor.conexao,menor.linha, end = ' ')
                    mensagemErro = None
                    dataHoraInicio = datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]
                    try:
                        self.tabelas[menor.linha.tabela].convert(self.conn_ifx, self.conn_sql, copy(menor.linha))
                    except Exception as erro:
                        mensagemErro = erro.__str__()

                    logging.info(f'{menor.conexao} {menor.linha} - {mensagemErro if mensagemErro else "Ok"}')

                    if not mensagemErro:
                        menor.cursor_update.execute(f"""
                            delete from mc_log
                            where
                                tabela = ? and
                                pk = ? and
                                data_hora <= ?
                            """,(menor.linha.tabela, menor.linha.pk,dataHoraInicio))
                        print('Ok')
                    else:
                        menor.cursor_update.execute(f"""
                            update mc_log
                            set
                                atualizacao = {'current' if menor.conexao == 'ifx' else 'getdate()'},
                                status = ?,
                                tentativas = tentativas + 1
                            where id = ?
                        """,(mensagemErro, menor.linha.id,))

                        menor.cursor_update.execute(f"""
                            delete from mc_log
                            where
                                tabela = ? and
                                pk = ? and
                                data_hora <= ? and
                                tentativas = 0
                            """,(menor.linha.tabela, menor.linha.pk,dataHoraInicio))

                        print(mensagemErro)


                menor.linha = menor.cursor.fetchone()
                menor.linha = Linha(*menor.linha) if menor.linha else None

                filas[menor.conexao] = menor
                menor = Fila(None,None,None,None)

            time.sleep(5)

def main():
    sincronizador = Sincroniza(
        'minas',
        'uf',
        'nacionalidade',
        'profissoes',
        'usuario',
        '_cota_',
    )
    sincronizador.process()

if __name__ == "__main__":
    logging.info('Início do sincronismo')
    main()
