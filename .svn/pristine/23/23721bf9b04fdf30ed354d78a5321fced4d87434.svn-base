#!/usr/bin/python
#

import os, time, logging

from pywebio.input import *
from pywebio.output import *
from pywebio.pin import *
from pywebio_battery import popup_input
from pywebio.session import *

from biblioteca.cria_triggers import *
from biblioteca.cria_sincronismo_tabela import *

#  Função nova para carregar o CSS
def load_custom_css():
    with open('front/static/style.css', encoding='utf-8') as f:
        css = f.read()
    put_html(f'<style>{css}</style>')

class Interface:
    def __init__(self, sincronizador):
        self.STOP = True
        self.Pause = False
        self.sincronizador = sincronizador
        self.create_widgets()

    def create_widgets(self):
        load_custom_css()  #  Carrega o CSS antes de montar a tela

        put_row([
            put_scope('menu').style('height: 100vh; width: 250px; background-color: #004078; position: fixed; top: 0; left: 0;'),
            put_scope('form').style('margin-left: 250px; padding: 20px; width: calc(100% - 250px); box-sizing: border-box;')
        ])


        with use_scope('menu') as menu:
            put_text('Sincronismo').style('color: white; font-size: 20px; background-color:#30b2ef;text-align: center;font-weight: bold;')
            put_button('Monitora serviço', onclick=self.monitora)
            put_button('Gera triggers', onclick=self.geraTriggers)
            put_button('Gera código', onclick=self.geraCodigoSincronismo)
            put_html('<div style="position: absolute; bottom: 0px; width: 250px; text-align: center;"><img src="/static/images/logo-minas2.jpg" style="width: 420px;" /></div>')

    def monitora(self):
        with use_scope('form', clear=True) as form:
            put_input(label="Intervalo de atualização", name='interval', type=NUMBER, value=5, position=0)
            put_buttons(['Para', 'Reinicia'], onclick=self.start_stop)
            put_text()
            put_text('Mensagens:')
            put_scrollable(put_scope('mensagens'), height=300, keep_bottom=True).style('width: 600px;')

    def geraTriggers(self):
        with use_scope('form', clear=True) as form:
            put_text('Criação de triggers').style('text-align: center;font-weight: bold;font-size: 30px;')
            put_html('<hr>')
            put_select(label="Banco de dados", name='banco', options=('Informix', 'MS-SQL'))
            put_select(label="Tabela", name='tabela', options=nomeTabelas(pin.banco))
            put_select(label="Chave primária", name='chavePrimaria', options=nomeColunas(pin.banco, f'select * from {pin.tabela}'), multiple=True).style('width: 600px;')
            put_button('Gera', onclick=self._geraTriggers_)

        pin_on_change('tabela', lambda nomeTabela: pin_update('chavePrimaria', options=nomeColunas(pin.banco, f'select * from {nomeTabela}')))

    def _geraTriggers_(self):
        if pin.banco == 'Informix':
            try:
                createTriggersInformix(pin.tabela, pin.chavePrimaria)
            except Exception as erro:
                put_error(erro, closable=True)
            else:
                put_success('Triggers gerados', closable=True)
        else:
            put_error('Em implementação', closable=True)

    def geraCodigoSincronismo(self):
        def getDados():
            self.dictDePara = {}
            self.query = None

            dados = []
            for coluna in nomeColunas(pin.banco, f'select * from {pin.tabelaDestino}'):
                dados.append({
                    'Destino': coluna,
                    'Origem': None,
                    'Referenciada': None,
                })

            return dados

        def getOrigem(rowid):
            form = popup_input(
                [
                    put_select(label="Origem", name='colunaOrigem', options=[None] + nomeColunas('MS-SQL' if pin.banco == 'Informix' else 'Informix', f'select * from {pin.tabelaOrigem}', ordenado=True)),
                    put_select(label="Referenciada", name='tabelaReferenciada', options=[None] + nomeTabelas(pin.banco)),
                ],
                title='Identifique a origem',
                cancelable=True
            )

            if form:
                if form['colunaOrigem']:
                    self.dictDePara[rowid] = (form['colunaOrigem'], form['tabelaReferenciada'])
                    datatable_update('dePara', form['tabelaReferenciada'], rowid, 'Referenciada')
                else:
                    if rowid in self.dictDePara:
                        del (self.dictDePara[rowid])

                return pin.colunaOrigem
            else:
                return None

        def getQuery(tabela):
            return self.query if self.query else f'select * from {tabela}'

        def alterQuery():
            self.query = {}
            cols = '\n   '+',\n   '.join(nomeColunas('MS-SQL' if pin.banco == 'Informix' else 'Informix', f'select * from {pin.tabelaOrigem}'))+'\n'

            form = popup_input(
                [
                    put_textarea(label='Query origem', name='queryOrigem', value = f"select {cols} from {pin.tabelaOrigem}"                    ),
                ],
                title = 'Query de origem',
                cancelable = True
            )

            if form:
                try:
                    self.query = pin.queryOrigem
                    nomeColunas('MS-SQL' if pin.banco == 'Informix' else 'Informix', self.query)
                except exception as erro:
                    put_error(erro)
            else:
                self.query = pin.queryOrigem

        with use_scope('form', clear=True) as form:
            put_text('Geração de script de sincronismo').style('text-align: center;font-weight: bold;font-size: 30px;')
            put_html('<hr>')
            put_row([
                put_select(label="Banco de dados destino", name='banco', options=('Informix', 'MS-SQL'), value='MS-SQL'),
                None,
                put_select(label="Tabela destino", name='tabelaDestino', options=nomeTabelas(pin.banco)),
            ], size='50% 10px 50%')

            put_row([
                put_select(label="Chave primária", name='chavePrimariaDestino', options=nomeColunas(pin.banco, f'select * from {pin.tabelaDestino}'), multiple=True),
                None,
                put_radio(label="Auto Incremento", name="autoIncremento", options=('Sim', 'Não'), value='Não'),
            ], size='50% 10px 50%')

            put_text('Tabela Origem')
            put_row(
                [
                    put_select(name='tabelaOrigem', options=(nomeTabelas('MS-SQL' if pin.banco == 'Informix' else 'Informix'))).style("width: 300px;"),
                    put_button('Alterar query', onclick=alterQuery)
                ]
            ),

            put_select(label="Chave primária", name='chavePrimariaOrigem', options=nomeColunas('MS-SQL' if pin.banco == 'Informix' else 'Informix', f'select * from {pin.tabelaOrigem}'), multiple=True).style('width: 600px;')

            put_datatable(
                getDados(),
                onselect=lambda rowid: datatable_update(
                    'dePara',
                    getOrigem(rowid),
                    rowid,
                    'Origem'
                ),
                id_field='Destino',
                instance_id='dePara',
                height='auto'
            )

            put_button('Gera', onclick=self._geraCodigoSincronismo_)

        pin_on_change('banco', lambda nomeBanco: pin_update('tabelaDestino', options=nomeTabelas(nomeBanco)))
        pin_on_change('banco', lambda nomeBanco: pin_update('tabelaOrigem', options=nomeTabelas('Informix' if nomeBanco == 'MS-SQL' else 'MS-SQL')))
        pin_on_change('tabelaDestino', lambda nomeTabela: datatable_update('dePara', getDados()))
        pin_on_change('tabelaDestino', lambda nomeTabela: pin_update('chavePrimariaDestino', options=nomeColunas(pin.banco, f'select * from {nomeTabela}')))
        pin_on_change('tabelaOrigem', lambda nomeTabela: pin_update('chavePrimariaOrigem', options=nomeColunas('Informix' if pin.banco == 'MS-SQL' else 'MS-SQL', getQuery(nomeTabela))))

    def _geraCodigoSincronismo_(self):
        if pin.banco == 'MS-SQL':
            try:
                createSincronismoIfxSql(
                    pin.tabelaOrigem,
                    pin.chavePrimariaOrigem,
                    pin.tabelaDestino,
                    pin.chavePrimariaDestino,
                    pin.autoIncremento,
                    self.dictDePara,
                )
            except Exception as erro:
                put_error(erro, closable=True)
            else:
                put_success('Código gerado', closable=True)
        else:
            put_error('Em implementação', closable=True)

    def start_stop(self, operacao):
        if operacao == 'Para':
            put_text('Pedido de parar', scope='mensagens')
            self.sincronizador.stop()
            put_text('Parado', scope='mensagens')

        if operacao == 'Reinicia':
            put_text('Pedido de reiniciar', scope='mensagens')
            self.sincronizador.start()

    def put_log(self, texto):
        put_text(texto, scope='mensagens')


# Teste
#
if __name__ == "__main__":
    from biblioteca.sincroniza import Sincroniza
    interface = Interface(Sincroniza())
